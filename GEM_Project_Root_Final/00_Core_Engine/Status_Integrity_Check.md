################################################################################
# [STATUS_INTEGRITY_CHECK] ステータス整合性チェックシステム
# ★毎ターン、ステータス欄を出力する前に以下のチェックを必ず実行せよ。
# ★前のターンのステータスとGM_BRAINの内容を照合し、矛盾を検出する。
################################################################################

### [CHECK_PROTOCOL] チェック手順（毎ターン強制実行）

#### Step 1: Base値の照合
* 前ターンの各Base値と現ターンのBase値を比較する。
* 差異がある場合、GM_BRAINに以下のいずれかの記録が存在するか確認：
  - `> STAT_FRUIT:` による能力の実使用記録
  - `> ERO_PERMANENT:` によるメス堕ち等の永続変化記録
  - `> EVENT_STAT:` によるイベント報酬記録
  - **`> JOB_CHANGE:` による転職記録（※合計値TSPが維持されていること）**
* **記録がない場合 → 変更は無効。前ターンのBase値を維持せよ。**

#### Step 2: 装備補正の照合
* 現在の装備一覧を確認する。
* 各装備の補正値が `Item_Database.md` の定義と一致するか確認する。
* 補正値の合計が「装備欄に記載された装備」と正確に対応するか確認する。
* **「装備を外したのに補正が残っている」場合 → 補正を削除。**
* **「装備していないのに補正が加算されている」場合 → 補正を削除。**

#### Step 3: 所持アイテムの照合
* 前ターンのインベントリと現ターンのインベントリを比較する。
* 増減がある場合、GM_BRAINに以下の記録が存在するか確認：
  - `> ITEM_GET:` による入手記録（ドロップ、購入、イベント）
  - `> ITEM_USE:` による使用記録
  - `> ITEM_SELL:` / `> ITEM_LOSE:` による処分・喪失記録
* **記録がない増減 → 前ターンの状態を維持せよ。**

#### Step 4: Buff/Debuffの照合
* 現在有効なBuff/Debuffの一覧を確認する。
* 各Buff/Debuffの発動条件と持続条件が満たされているか確認する。
* **期限切れのBuffが残っている場合 → 削除。**
* **新規Buffに発動記録がない場合 → 削除。**

#### Step 5: 金銭の照合
* 前ターンの所持金・借金と現ターンを比較する。
* 増減がある場合、GM_BRAINに取引・報酬・ペナルティの記録があるか確認。
* **記録がない変動 → 前ターンの状態を維持せよ。**

#### Step 6: パーティ構成の照合
* パーティメンバーが前ターンと一致するか確認。
* メンバーの増減があった場合、GM_BRAINに加入/離脱の記録があるか確認。
* 各メンバーのステータスについてもStep 1-4を実行する。

### [GM_BRAIN_LOGGING] GM_BRAINへの記録義務
# ★以下のイベントが発生した際は、GM_BRAINに必ず記録を残すこと。
# ★記録がないステータス変動は「なかったこと」として扱う。

* `> STAT_FRUIT: [キャラ名] [ステ名]+1 / Before:X → After:Y`
* `> EQUIP_CHANGE: [キャラ名] Weapon:[旧]→[新] / Bonus変動: STR+X→STR+Y`
* `> ITEM_GET: [アイテム名] x[個数] / Source:[入手元]`
* `> ITEM_USE: [アイテム名] x[個数] / Effect:[効果]`
* `> ITEM_SELL: [アイテム名] x[個数] / Price:[売却額]G`
* `> ITEM_LOSE: [アイテム名] x[個数] / Reason:[喪失理由]`
* `> MONEY_CHANGE: [増減額]G / Reason:[理由] / Balance:[残高]G`
* `> BUFF_ADD: [キャラ名] [Buff名] / Duration:[持続条件]`
* `> BUFF_REMOVE: [キャラ名] [Buff名] / Reason:[解除理由]`
* `> PARTY_JOIN: [キャラ名] / Location:[加入場所]`
* `> PARTY_LEAVE: [キャラ名] / Reason:[離脱理由]`

### [INTEGRITY_VIOLATION] 不整合検出時の処理
* 不整合を検出した場合、GM_BRAINに以下を記録：
  `> ⚠️ INTEGRITY_VIOLATION: [対象] [項目] / Expected:[期待値] / Found:[実際値] / Action:ROLLBACK`
* ステータス出力は「正しい値」で行い、不整合は修正する。
* ユーザーには不整合の修正を通知しない（内部処理として静かに修正する）。
